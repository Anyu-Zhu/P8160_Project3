---
title: "mcmc"
output: html_document
---

```{r setup, message = FALSE}
library(tidyverse)
library(lubridate)
library(extraDistr)
library(rWishart)
library(MASS)
```

```{r}
# --- Import data ---
hurrican <- read_csv("./hurrican703.csv") %>% 
  janitor::clean_names() %>% 
  separate(time, into = c("date", "hour"), sep = " ") %>% 
  filter(hour == "00:00:00)" | hour == "06:00:00)" | hour == "12:00:00)" | hour == "18:00:00)") %>% 
  mutate(hour = str_replace(hour, ":00:00\\)", ""),
         hour = as.numeric(hour),
         date = str_replace(date, "\\(", ""),
         date = yday(date),
         nature = as.numeric(as.factor(nature))) %>% 
  group_by(id) %>% 
  mutate(latitude_d = lead(latitude) - latitude,
         longitude_d = lead(longitude) - longitude,
         wind_kt_d = lead(wind_kt) - wind_kt,
         wind_kt_2 = lead(wind_kt)) %>% 
  na.omit() %>% 
  mutate(intercept = 1) %>% 
  relocate(13,14,9,10,11,12) 

Xlist = hurrican %>% 
  dplyr::select(2:6, id) %>% 
  nest() %>% 
  pull(data)

Ylist = hurrican %>% 
  dplyr::select(1, id) %>% 
  nest() %>% 
  pull(data)
```

```{r}
# B for beta matrix
B = function(x_dat, y_dat, mu_est, sigma_sq, sigma_inv){
  res = vector("list", length = length(x_dat))
  n = length(x_dat)
  # Beta_i function ~ N(V^-1*M, V^-1)
  for (i in 1:n){
    x = as.matrix(x_dat[[i]])
    y = as.vector(y_dat[[i]])
    k = sigma_inv + sigma_sq^(-1) * t(x) %*% x
    m = sigma_sq^(-1) * (t(y) %*% x)  + t(mu_est) %*% sigma_inv
    varcov = solve(k)
    mu = varcov %*% t(m)
    bi = mvrnorm(1, mu = mu, Sigma = varcov)
    res[[i]] = list(bi = bi)
  }
  # Final res is the 700 x 5 matrix 
  return(res)
}

B(Xlist[1:10], Ylist[1:10], mu_est = ini.mu, sigma_sq = ini.sig, sigma_inv = ini.bsig)
```

```{r}
## sigma_sq
sigma_sq <- function(B){
  
  n = length(unique(hurrican$id))
  sum_ki = 0
  res = NULL
  ids = unique(hurrican$id)
  for (i in 1:n){
    hurr_i <- hurrican %>% filter(id == ids[i])
    rowcount <- nrow(hurr_i)
    sum_ki = sum_ki + rowcount
  
    y = hurr_i[,1]
    x = cbind(rep(1, nrow(hurr_i)), hurr_i[, 2:6]) %>% as.matrix()
    ssr = sum((y - x %*% t(B[i]))^2)
    res = rbind(res, ssr)
  }
  
  alpha = sum_ki/2 + 2
  beta = res/2
  sigma = rinvgamma(1, alpha, beta)
  return(sigma)
}
```


```{r}
#big sigma inverse
sigma_inv = function(B, mu_est){
  n = nrow(B) # n is number of hurricane
  d = ncol(B)
  
  scalematx = diag(0,d,d)
  
  for (i in 1:n) {
    betai = B[i,]
    scalematx = scalematx + t(betai - mu_est) %*% (betai - mu_est)
  }
  
  omega = scalematx + diag(1,d,d) #omega is the scale matrix
  sigmaws = rinvwishart(1, nu = n + d + 1, Omega = omega, checkSymmetry = F) 
  sigmaws = matrix(sigmaws, nrow = d, ncol = d)
  return(sigmaws)
}
```


```{r}
## Mu
mu_est = function(B, sigma_inv){
  col_mu = colMeans(B)
  n = nrow(B)
  mu = mvrnorm(1, col_mu, sigma_inv / n) 
  return(mu)
}
```

## MCMC
```{r}
mcmc = function(x_dat, y_dat, ini.mu, ini.bsig, ini.sig, niter){
  beta.i = vector("list", length = niter) # in each iteration, betai - 365x8
  b.sig = vector("list", length = niter)
  sigma = rep(NA, niter)
  mu = vector("list", length = niter)
  
  # Initial values:
  beta.i[[1]] <- B(x_dat, y_dat, mu_est = ini.mu, sigma_sq = ini.sig, sigma_inv = ini.bsig)
  sigma[1] <- ini.sig
  mu[[1]] <- ini.mu
  b.sig[[1]] <- ini.bsig

  # Do gibbs sampler
  for (i in 2:niter){
    beta.i[[i]] = B(x_dat, y_dat, mu_est = mu[[i-1]], sigma_sq = sigma[i-1], sigma_inv = b.sig[[i-1]])
    sigma[i] = sigma_sq(B = beta.i[[i]])
    b.sig[[i]] = sigma_inv(B = beta.i[[i]], mu_est = mu[[i-1]])
    mu[[i]] = mu_est(B = beta.i[[i]], sigma_inv = b.sig[[i]])

    }
  return(list(B = beta.i, sigma_sq = sigma, sigma_inv = b.sig, mu_est = mu))
}
```

### Test
```{r}
ini.mu = c(50,rep(0,4))
ini.sig = .5
ini.bsig = diag(.5,5,5)

mcmc(x = Xlist[1:10], y = Ylist[1:10], ini.mu, ini.sig, ini.bsig, niter = 100)
```

