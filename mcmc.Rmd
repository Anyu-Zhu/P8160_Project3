---
title: "mcmc"
output: html_document
---

```{r setup, message = FALSE}
library(tidyverse)
library(lubridate)
library(extraDistr)
library(rWishart)
```

```{r}
# --- Import data ---
hurrican <- read_csv("./hurrican703.csv") %>% 
  janitor::clean_names() %>% 
  separate(time, into = c("date", "hour"), sep = " ") %>% 
  filter(hour == "00:00:00)" | hour == "06:00:00)" | hour == "12:00:00)" | hour == "18:00:00)") %>% 
  mutate(hour = str_replace(hour, ":00:00\\)", ""),
         hour = as.numeric(hour),
         date = str_replace(date, "\\(", ""),
         date = yday(date),
         nature = as.numeric(as.factor(nature))) %>% 
  group_by(id) %>% 
  mutate(latitude_d = lead(latitude) - latitude,
         longitude_d = lead(longitude) - longitude,
         wind_kt_d = lead(wind_kt) - wind_kt,
         wind_kt_2 = lead(wind_kt)) %>% 
  na.omit()  
```


```{r parameters}

ids = unique(hurrican$id)
n = length(unique(hurrican$id))

# B for beta matrix
ssr = 0
for (i in 1:n){
  hurr_i <- hurrican %>% filter(id == ids[i])
  y = hurr_i[,2]
  x = cbind(rep(1, nrow(hurr_i)), hurr_i[, 3:6])
  x = as.matrix(x)
  ssr = sum((y - x %*% t(B[i]))^2)
  res = rbind(res, ssr)
}

sigma <- function(){
  alpha = sum_ki/2 + 2
  beta = res/2
  sigma = rinvgamma(1, alpha, beta)
  return(sigma)
}

#big sigma inverse
sigma_inv = function(B, mu){
  n = nrow(B) # n is number of hurricane
  d = ncol(B)
  
  scalematx = diag(0,d,d)
  
  for (i in 1:n) {
    betai = B[i,]
    scalematx = scalematx + t(betai - mu) %*% (betai - mu)
  }
  
  omega = scalematx + diag(1,d,d) #omega is the scale matrix
  sigmaws = rinvwishart(1, nu = n + d + 1, Omega = omega, checkSymmetry = F) 
  sigmaws = matrix(sigmaws, nrow = d, ncol = d)
  return(sigmaws)
}

mu_est = function(betai, SigmaB){
  col_mu = colMeans(betai)
  n = nrow(betai)
  mu = mvrnorm(1, col_mu, SigmaB / n) 
  return(mu)
}
```

