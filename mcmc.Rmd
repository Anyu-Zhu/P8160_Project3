---
title: "mcmc"
output: html_document
---

```{r setup, message = FALSE}
library(tidyverse)
library(lubridate)
library(extraDistr)
library(rWishart)
library(MASS)
library(matrixsampling)
library(caret)
```

```{r}
# --- Import data ---
hurrican <- read_csv("./hurrican703.csv") %>% 
  janitor::clean_names() %>% 
  separate(time, into = c("date", "hour"), sep = " ") %>% 
  filter(hour == "00:00:00)" | hour == "06:00:00)" | hour == "12:00:00)" | hour == "18:00:00)") %>% 
  mutate(hour = str_replace(hour, ":00:00\\)", ""),
         hour = as.numeric(hour),
         date = str_replace(date, "\\(", ""),
         date = yday(date)) %>% 
  group_by(id) %>% 
  mutate(latitude_d = lead(latitude) - latitude,
         longitude_d = lead(longitude) - longitude,
         wind_kt_d = wind_kt - lag(wind_kt),
         wind_kt_2 = lead(wind_kt)) %>% 
  na.omit() %>% 
  mutate(intercept = 1) %>% 
  relocate(13,14,9,10,11,12) %>%
  ### Drop the hurricane data point( < 5) 
  filter(!(id %in% c("TEN:UNNAMED.1988","EIGHT.2013", "TEN.2007", "JOSE.2005", "AMELIA.1978",
                     "BRET.2005", "FERNAND.2013", "FIFTEEN:UNNAMED.1988", "KYLE.1996")))

Xlist = hurrican %>% 
  dplyr::select(2:6, id) %>% 
  nest() %>% 
  pull(data)

Ylist = hurrican %>% 
  dplyr::select(1, id) %>% 
  nest() %>% 
  pull(data)
```

```{r}
# B for beta matrix
B = function(x_dat, y_dat, mu_est, sigma_sq, sigma_inv){
  res = NULL
  n = length(x_dat)
  # Beta_i function ~ N(V^-1*M, V^-1)
  for (i in 1:n){
    x = as.matrix(x_dat[[i]])
    y = as.vector(y_dat[[i]])
    k = sigma_inv + sigma_sq^(-1) * t(x) %*% x
    m = sigma_sq^(-1) * (t(y) %*% x)  + t(mu_est) %*% sigma_inv
    varcov = solve(k)
    mu = varcov %*% t(m)
    bi = mvrnorm(1, mu = mu, Sigma = varcov)
    res = rbind(res, bi)
  }
  # Final res is the 700 x 5 matrix 
  return(as.matrix(res))
}
```

```{r}
## sigma_sq
sigma_sq <- function(B){
  
  n = length(10)
  sum_ki = 0
  res = NULL
  ids = unique(hurrican$id)
  for (i in 1:n){
    hurr_i <- hurrican %>% filter(id == ids[i])
    rowcount <- nrow(hurr_i)
    sum_ki = sum_ki + rowcount
  
    y = hurr_i[,1]
    x = hurr_i[, 2:6] %>% as.matrix()
    z = as.matrix(B[i,])

    ssr = sum((y - x %*% z)^2)
    res = rbind(res, ssr)
  }
  
  alpha = sum_ki/2 + 2
  beta = res/2
  sigma = rinvgamma(1, alpha, beta)
  return(sigma)
}

```


```{r}
#big sigma inverse
sigma_inv = function(B, mu_est){
  n = nrow(B) # n is number of hurricane
  d = ncol(B)
  
  scalematx = diag(0,d,d)
  
  for (i in 1:n) {
    betai = as.matrix(B[i,])
    scalematx = scalematx + (betai - (mu_est)) %*% t(betai - mu_est)
  }
  
  omega = scalematx + diag(1,d,d) #omega is the scale matrix
  sigmaws = rinvwishart(1, nu = n + 3 * d + 3, Omega = omega, checkSymmetry = F) 
  sigmaws = matrix(sigmaws, nrow = d, ncol = d)
  return(sigmaws)
}

```


```{r}
## Mu
mu_est = function(B, sigma_inv){
  col_mu = colMeans(B)
  n = nrow(B)
  mu = mvrnorm(1, col_mu, sigma_inv / n) 
  return(mu)
}
```

## MCMC
```{r}
mcmc = function(x_dat, y_dat, ini.mu, ini.bsig, ini.sig, niter){
  beta.i = vector("list", length = niter) # in each iteration, betai - 365x8
  b.sig = vector("list", length = niter)
  sigma = rep(NA, niter)
  mu = vector("list", length = niter)
  
  # Initial values:
  beta.i[[1]] <- B(x_dat, y_dat, mu_est = ini.mu, sigma_sq = ini.sig, sigma_inv = ini.bsig)
  sigma[1] <- ini.sig
  mu[[1]] <- ini.mu
  b.sig[[1]] <- ini.bsig

  # Do gibbs sampler
  for (i in 2:niter){
    beta.i[[i]] = B(x_dat, y_dat, mu_est = mu[[i-1]], sigma_sq = sigma[i-1], sigma_inv = b.sig[[i-1]])
    sigma[i] = sigma_sq(B = beta.i[[i]])
    b.sig[[i]] = sigma_inv(B = beta.i[[i]], mu_est = mu[[i-1]])
    mu[[i]] = mu_est(B = beta.i[[i]], sigma_inv = b.sig[[i]])
  }
  
  return(list(B = beta.i, sigma_sq = sigma, sigma_inv = b.sig, mu_est = mu))
}
```

```{r}
ini.mu = c(50,rep(0,4))
ini.sig = .5
ini.bsig = diag(.5,5,5)

## Data Partition 
hurr_test = NULL
hurr_train = NULL
ids = unique(hurrican$id)
for (i in 1:length(ids)) {
    hurr_i <- hurrican %>% filter(id == ids[i])
    
    ## separate data
    fold_index = cut(seq(1,nrow(hurr_i)),breaks = 5, labels = FALSE)
    hurr_train_1 = hurr_i[fold_index != 1, ]
    hurr_test_1 = hurr_i[fold_index == 1, ]
    
    ## Combine data
    hurr_train = rbind(hurr_train, hurr_train_1)
    hurr_test = rbind(hurr_test, hurr_test_1)
}

## Data into list for MCMC
Xlist_train = hurr_train %>%
  group_by(id) %>% 
  dplyr::select(2:6, id) %>% 
  nest() %>% 
  pull(data)

Ylist_train = hurr_train %>%
  group_by(id) %>%
  dplyr::select(1, id) %>% 
  nest() %>% 
  pull(data)

Xlist_test = hurr_test %>%
  group_by(id) %>% 
  dplyr::select(2:6, id) %>% 
  nest() %>% 
  pull(data)

Ylist_test = hurr_test %>%
  group_by(id) %>%
  dplyr::select(1, id) %>% 
  nest() %>% 
  pull(data)

## MCMC to obtain coefficients beta
rest_final = mcmc(x = Xlist_train, y = Ylist_train, ini.mu, ini.bsig, ini.sig, niter = 100)

## final results for each hurricane and predictor
beta_coef_all = NULL
beta_coef = NULL
beta_coef_final = NULL

for (i in 1:691) {
  hurr_train_x = Xlist_train[[i]]
  hurr_train_y = Ylist_train[[i]]
  hurr_train = cbind(hurr_train_y, hurr_train_x)
  hurr_test = Xlist_test[[i]]
  
  ## Coefficients for each hurricane for MCMC
  beta_coef = colMeans(t(matrix(unlist(rest_test$B), 5, 100))[50:100, ])
  mu_coef = colMeans(t(matrix(unlist(rest_test$mu_est), 5, 100))[50:100, ])
  pred_test = as.matrix(hurr_test) %*% as.matrix(beta_coef)
  
  ## Mu for each hurricane
  
  ## lm coefficients
  lm_fit = lm(wind_kt_2 ~ wind_kt + latitude_d + longitude_d + wind_kt_d, data = hurr_train)
  lm_fit_coef = lm_fit$coefficients
  
  ## RMSE
  RMSE_value = RMSE(pred_test, Ylist_test[[i]]$wind_kt_2)
  
  beta_coef_final = rbind(beta_coef_final, c(RMSE_value, beta_coef, lm_fit_coef, mu_coef))
}
```


### Test
```{r}
ini.mu = c(50,rep(0,4))
ini.sig = .5
ini.bsig = diag(.5,5,5)

Xlist1 = hurrican %>%
  ungroup() %>% 
  dplyr::select(2:6) %>% 
  nest() %>% 
  pull(data)

Ylist1 = hurrican %>%
  ungroup() %>% 
  dplyr::select(1) %>% 
  nest() %>% 
  pull(data)

rest_test_all = mcmc(x = Xlist, y = Ylist, ini.mu, ini.bsig, ini.sig, niter = 10)

rest_test_all$B[[2]]

all_coef = colMeans(t(matrix(unlist(rest_test_all$B), 5, 5000)))

plot_beta_ch = NULL
for (i in 100:5000) {
  plot_beta_ch = rbind(plot_beta_ch, rest_test_all$B[i][[1]])
}
colnames(plot_beta_ch) = c("Intercept", "beta1", "beta2", "beta3", "beta4")

plot_df = plot_beta_ch %>% 
  as.data.frame() %>% 
  mutate(index = 100:5000) %>% 
  pivot_longer(cols = 1:5,
               names_to = "Predictor",
               values_to = "Coefficient")

ggplot(plot_df, aes(x = index, y = Coefficient)) +
  geom_line() +
  theme_bw() + 
  facet_grid(Predictor ~ ., scales = "free")

pred_test_1 =  as.matrix(Xlist1[[1]]) %*% as.matrix(all_coef)
RMSE(pred_test_1, as.matrix(Ylist1[[1]]))
```

## Test prediction for each hurricane
```{r}
## Initial value
ini.mu = c(50,rep(0,4))
ini.sig = .5
ini.bsig = diag(.5,5,5)

## Prediction for each hurricane
set.seed(666)
res = NULL
ids = unique(hurrican$id)
  for (i in 1:length(ids)){
    hurr_i <- hurrican %>% filter(id == ids[i])
    #trRow <- createDataPartition(1:12, p = 0.8, list = F)
    ## Train
    #hurr_train = hurr_i[trRow,]
    ## Test
    #hurr_test = hurr_i[-trRow,]
    
    ## separate data
    fold_index = cut(seq(1,nrow(hurr_i)),breaks = 5, labels = FALSE)
    hurr_train = hurr_i[fold_index != 1, ]
    hurr_test = hurr_i[fold_index == 1, ]
    
    ## List for beta
    Xlist_train = hurr_train %>% 
            dplyr::select(2:6, id) %>% 
            nest() %>% 
            pull(data)
    Ylist_train = hurr_train %>% 
      dplyr::select(1, id) %>% 
      nest() %>% 
      pull(data)
    
    ##MCMC
    rest_test = mcmc(x = Xlist_train, y = Ylist_train, ini.mu, ini.bsig, ini.sig, niter = 5000)
    beta_coef = colMeans(t(matrix(unlist(rest_test$B), 5, 5000))[3500:5000, ])
    mu_coef = colMeans(t(matrix(unlist(rest_test$mu_est), 5, 5000))[3500:5000, ])
    final_coef = beta_coef %>% as.double()
    pred_test =  as.matrix(hurr_test[2:6]) %*% as.matrix(beta_coef)
    
    ## lm coefficients
    lm_fit = lm(wind_kt_2 ~ wind_kt + latitude_d + longitude_d + wind_kt_d, data = hurr_train)
    lm_fit_coef = lm_fit$coefficients
    
    ## RMSE
    RMSE_value = RMSE(pred_test, hurr_test$wind_kt_2, na.rm = T)
    
    ## Result for each hurricane, RMSE test value and final coefficients
    res = rbind(res, c(i, RMSE_value, final_coef, lm_fit_coef, mu_coef))
  }

res

```

```{r}
dat = data.frame(res)

dat = dat %>% 
  dplyr::select(-1:-2) %>% 
  drop_na()

## qq plot to see whether lm and mcmc follow the same trend
qqplot(dat$V4, dat$wind_kt, xlab = "mcmc", ylab = "lm", main = "Q-Q Plot")

colMeans(t(matrix(unlist(rest_test$mu_est), 5, 5000))[4000:5000, ])
```

```{r}
dat_1 <- read_csv("./res_1_140.csv")
dat_2 <- read_csv("./res141_280.csv")
dat_3 <- read_csv("./res281-420.csv")
dat_4 <- read_csv("./res_id_421_560.csv")
dat_5 <- read_csv("./res560-691.csv")

dat_1 <- dat_1[, c(4:8)]
colnames(dat_1) <- c("beta_0", "beta_1", "beta_2", "beta_3", "beta_4")

dat_2 <- dat_2[, c(2:6)]
colnames(dat_2) <- c("beta_0", "beta_1", "beta_2", "beta_3", "beta_4")

dat_3 <- dat_3[, c(4:8)]
colnames(dat_3) <- c("beta_0", "beta_1", "beta_2", "beta_3", "beta_4")

dat_4 <- dat_4[, c(3:7)]
colnames(dat_4) <- c("beta_0", "beta_1", "beta_2", "beta_3", "beta_4")

dat_5 <- dat_5[-1, c(4:8)]
colnames(dat_5) <- c("beta_0", "beta_1", "beta_2", "beta_3", "beta_4")

res_1 = rbind(dat_1, dat_2, dat_3, dat_4, dat_5)

write.csv(res_1, "res_1.csv")
```


